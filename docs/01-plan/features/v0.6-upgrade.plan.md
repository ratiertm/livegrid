# Plan: v0.6 - DBMS & API Enhancements

> **Feature**: v0.6-upgrade
> **Created**: 2026-02-22
> **Status**: Draft
> **Priority**: High

---

## 1. Overview

v0.5까지 구현된 LiveView Grid의 DBMS 및 REST API 기능을 강화하는 업그레이드입니다.
7개 항목을 구현 난이도와 영향도 기준으로 우선순위를 정해 순차 개발합니다.

## 2. Goals

### 2.1 Primary Goals
- [ ] PATCH 메서드 지원 (부분 업데이트)
- [ ] API Key 인증 적용 (API 요청 시 키 검증)
- [ ] 커서 기반 페이지네이션
- [ ] 대용량 데이터 스트리밍 (Repo.stream)
- [ ] 멀티 DB 드라이버 (PostgreSQL, MySQL)
- [ ] 멀티 DB 드라이버 (MSSQL, Oracle)
- [ ] GraphQL 데이터 소스 지원

### 2.2 Non-Goals
- UI 디자인 변경 (기존 대시보드 유지)
- 기존 기능 리팩토링 (v0.1~v0.5 안정성 유지)
- 프로덕션 배포 설정

## 3. Implementation Items (우선순위순)

### Item 1: PATCH 메서드 지원 ⭐ Quick Win
**난이도**: Low | **영향도**: Medium

**현재 상태**: API 문서에는 정의되어 있으나 코드 미구현
- `api_doc_live.ex`에 PATCH 엔드포인트 스펙 존재
- `MockApiController`에 PUT만 구현, PATCH 없음
- `DataSource.Rest`에 `:put`만 사용

**구현 범위**:
1. `MockApiController`에 `patch/2` 액션 추가 (부분 필드 업데이트)
2. `router.ex`에 `patch "/users/:id"` 라우트 추가
3. `DataSource.Rest`에 `partial_update_row/3` 함수 추가
4. `DataSource` behaviour에 `partial_update_row/3` 콜백 추가
5. `GridComponent`에서 PATCH vs PUT 선택 옵션

**수정 파일**:
- `lib/liveview_grid_web/controllers/mock_api_controller.ex`
- `lib/liveview_grid_web/router.ex`
- `lib/liveview_grid/data_source/rest.ex`
- `lib/liveview_grid/data_source.ex`

---

### Item 2: API Key 인증 적용 ⭐ Quick Win
**난이도**: Medium | **영향도**: High

**현재 상태**: API Key 스키마와 관리 UI 존재, 인증 미적용
- `ApiKey` 스키마: key, prefix, status, permissions, last_used_at, expires_at 필드
- `ApiKeys` 컨텍스트: list/create/revoke/delete 함수
- `api_key_live.ex`: 관리 UI
- **인증 Plug 없음**, API 엔드포인트 완전 개방 상태

**구현 범위**:
1. `RequireApiKey` Plug 생성
   - `Authorization: Bearer lvg_xxx` 헤더에서 키 추출
   - DB 조회로 키 유효성 검증 (status: active)
   - permissions 확인 (read / read_write / admin)
   - expires_at 만료 체크
   - last_used_at 갱신
2. `ApiKeys` 컨텍스트에 검증 함수 추가
   - `validate_key/1` - 키 존재 및 활성 상태 확인
   - `check_permission/2` - 권한 검증
3. Router API 파이프라인에 Plug 적용
4. 401/403 에러 응답 형식 정의

**생성 파일**:
- `lib/liveview_grid_web/plugs/require_api_key.ex` (신규)

**수정 파일**:
- `lib/liveview_grid/api_keys.ex`
- `lib/liveview_grid_web/router.ex`

---

### Item 3: 커서 기반 페이지네이션
**난이도**: Medium | **영향도**: Medium

**현재 상태**: 오프셋 기반만 구현
- `QueryBuilder.apply_pagination/3`: LIMIT/OFFSET 사용
- `Grid` state: `pagination.current_page` 만 관리
- REST adapter: `page`, `page_size` 파라미터만 지원

**구현 범위**:
1. 커서 인코딩/디코딩 모듈 (`Cursor`)
   - `{last_id, last_sort_value}` → Base64 인코딩
   - 커서 파싱 및 유효성 검증
2. `QueryBuilder`에 커서 기반 WHERE 절 추가
   - `WHERE id > :cursor_id ORDER BY id LIMIT :page_size`
3. Grid state에 `pagination_mode: :offset | :cursor` 추가
4. REST adapter에 `cursor` 파라미터 지원
5. MockApiController에 커서 응답 생성
6. GridComponent에 페이지네이션 모드 선택 옵션

**생성 파일**:
- `lib/liveview_grid/cursor.ex` (신규)

**수정 파일**:
- `lib/liveview_grid/data_source/ecto/query_builder.ex`
- `lib/liveview_grid/data_source/rest.ex`
- `lib/liveview_grid/grid.ex`
- `lib/liveview_grid_web/controllers/mock_api_controller.ex`

---

### Item 4: Repo.stream (대용량 스트리밍)
**난이도**: Medium | **영향도**: Medium

**현재 상태**: `repo.all()`로 전체 결과 한번에 로드
- `DataSource.Ecto` 45행: `repo.all()` 사용
- 대용량 데이터 시 메모리 문제 가능

**구현 범위**:
1. `DataSource.Ecto`에 스트리밍 모드 옵션 추가
   - `stream: true` 옵션 시 `Repo.stream` 사용
2. `Repo.transaction` 내에서 Stream 처리
3. 청크 단위 데이터 전송 (LiveView 스트리밍)
4. 메모리 사용량 모니터링 함수

**수정 파일**:
- `lib/liveview_grid/data_source/ecto.ex`
- `lib/liveview_grid/data_source.ex` (옵션 추가)

---

### Item 5: 멀티 DB 드라이버 (PostgreSQL, MySQL)
**난이도**: High | **영향도**: High

**현재 상태**: SQLite만 지원
- `mix.exs`: `ecto_sqlite3` (~> 0.17) 의존성
- `Repo`: `Ecto.Adapters.SQLite3` 하드코딩
- 단일 Repo 구조

**구현 범위**:
1. `mix.exs`에 드라이버 의존성 추가 (optional)
   - `postgrex` (~> 0.19)
   - `myxql` (~> 0.7)
2. 동적 Repo 설정 시스템
   - 런타임 DB 어댑터 선택
   - 환경변수 기반 설정 (`DATABASE_ADAPTER`)
3. DB별 QueryBuilder 호환성 테스트
   - SQLite/PostgreSQL/MySQL SQL 차이 처리
4. 연결 풀 관리 (DBConnection)
5. DBMS 데모 페이지에 드라이버 선택 UI

**수정 파일**:
- `mix.exs`
- `config/config.exs`, `config/runtime.exs`
- `lib/liveview_grid/repo.ex`
- `lib/liveview_grid/data_source/ecto/query_builder.ex` (SQL 호환성)

---

### Item 6: 멀티 DB 드라이버 (MSSQL, Oracle)
**난이도**: High | **영향도**: Medium

**현재 상태**: 미구현

**구현 범위**:
1. `mix.exs`에 드라이버 의존성 추가 (optional)
   - `tds_ecto` (~> 3.0) for MSSQL
   - `ecto_oracle` (가용 버전 확인 필요)
2. Item 5와 동일한 동적 Repo 시스템 확장
3. MSSQL/Oracle 고유 SQL 문법 처리
   - TOP vs LIMIT, ROWNUM 등
4. 연결 테스트 및 문서화

**의존성**: Item 5 완료 후 진행

**수정 파일**:
- `mix.exs`
- `lib/liveview_grid/data_source/ecto/query_builder.ex`

---

### Item 7: GraphQL 데이터 소스
**난이도**: Very High | **영향도**: Medium

**현재 상태**: 미구현 (GraphQL 관련 코드 0)

**구현 범위**:
1. `mix.exs`에 의존성 추가
   - `absinthe` (~> 1.7)
   - `absinthe_phoenix` (~> 2.0)
2. GraphQL 스키마 정의
   - Grid 타입, Query, Mutation
3. Resolver 구현
   - 기존 Grid 모듈 연동
4. `DataSource.GraphQL` 어댑터 생성
   - GraphQL 쿼리 빌더
   - Subscription 지원 (실시간)
5. Router에 GraphQL 엔드포인트 추가
6. GraphiQL UI (개발 전용)

**생성 파일**:
- `lib/liveview_grid/graphql/schema.ex` (신규)
- `lib/liveview_grid/graphql/resolvers/` (신규 디렉토리)
- `lib/liveview_grid/data_source/graphql.ex` (신규)

**수정 파일**:
- `mix.exs`
- `lib/liveview_grid_web/router.ex`

## 4. Implementation Order

```
Phase A (Quick Wins) ─────────────────────
  ├── Item 1: PATCH 메서드        ~0.5일
  └── Item 2: API Key 인증        ~1일

Phase B (Core Enhancements) ──────────────
  ├── Item 3: 커서 페이지네이션    ~1일
  └── Item 4: Repo.stream         ~1일

Phase C (DB Expansion) ──────────────────
  ├── Item 5: PostgreSQL/MySQL    ~2일
  └── Item 6: MSSQL/Oracle        ~1일 (Item 5 이후)

Phase D (GraphQL) ───────────────────────
  └── Item 7: GraphQL             ~3일
```

**예상 총 소요**: ~9.5일

## 5. Success Criteria

| 항목 | 기준 |
|------|------|
| PATCH | `PATCH /api/v1/grid/:id/rows/:row_id` 동작, 부분 필드만 수정됨 |
| API Key | 키 없이 API 호출 시 401, 잘못된 키 403, 권한 부족 403 |
| 커서 페이지네이션 | 커서 토큰으로 다음 페이지 조회 가능, 일관된 결과 |
| Repo.stream | 10만 행 데이터 처리 시 메모리 일정 유지 |
| Multi-DB | PostgreSQL/MySQL 연결 및 CRUD 정상 동작 |
| GraphQL | GraphQL 쿼리로 Grid 데이터 조회/수정 가능 |

## 6. Risks & Mitigations

| 리스크 | 영향 | 완화 방안 |
|--------|------|----------|
| DB 드라이버 호환성 | SQL 문법 차이로 QueryBuilder 오류 | DB별 SQL 방언 추상화 레이어 |
| GraphQL 복잡도 | 개발 기간 초과 | Phase D를 v0.7로 연기 가능 |
| API Key 성능 | 매 요청마다 DB 조회 | ETS 캐시 적용 |
| Repo.stream 트랜잭션 | 장시간 트랜잭션 유지 | 타임아웃 설정, 청크 크기 최적화 |

## 7. Testing Strategy

- 각 Item별 ExUnit 테스트 작성
- PATCH: HTTP 메서드별 응답 검증
- API Key: 인증 성공/실패/만료/권한 시나리오
- 커서: 순방향/역방향/정렬 조합 테스트
- Multi-DB: Docker 기반 각 DB 인스턴스 테스트 (CI)
- GraphQL: Absinthe 테스트 헬퍼 활용
