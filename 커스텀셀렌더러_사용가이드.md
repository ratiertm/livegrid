# 커스텀 셀 렌더러 사용 가이드

> **기능 코드**: F-300
> **버전**: v0.5.0
> **작성일**: 2026-02-21

---

## 1. 개요

커스텀 셀 렌더러는 그리드의 셀 표시 방식을 자유롭게 변경할 수 있는 기능입니다.

기본적으로 그리드는 셀 값을 **일반 텍스트**로 표시하지만, `renderer` 옵션을 지정하면
뱃지, 링크, 프로그레스바 등 원하는 형태로 렌더링할 수 있습니다.

### 적용 전/후 비교

| 컬럼 | 적용 전 (plain text) | 적용 후 (renderer) |
|------|---------------------|-------------------|
| 이메일 | `alice@example.com` | 클릭 가능한 파란색 링크 |
| 나이 | `35` | 초록색 프로그레스바 + 숫자 |
| 도시 | `서울` | 파란색 둥근 뱃지 |

---

## 2. 기본 사용법

컬럼 정의에 `renderer` 키를 추가하면 됩니다.

```elixir
columns={[
  # renderer 없음 → 기존 plain text
  %{field: :id, label: "ID", width: 80},

  # renderer 적용 → 커스텀 렌더링
  %{field: :city, label: "도시", width: 120,
    renderer: LiveViewGrid.Renderers.badge(
      colors: %{"서울" => "blue", "부산" => "green"}
    )}
]}
```

- `renderer`를 지정하지 않으면 (또는 `nil`) 기존 plain text 동작
- `renderer`를 지정하면 해당 함수가 셀 내용을 대신 렌더링

---

## 3. 내장 렌더러 프리셋

### 3.1 Badge (뱃지)

값을 **색상 뱃지**로 표시합니다. 카테고리, 상태, 지역 등에 적합합니다.

```elixir
%{field: :city, label: "도시",
  renderer: LiveViewGrid.Renderers.badge(
    colors: %{
      "서울" => "blue",
      "부산" => "green",
      "대구" => "red",
      "인천" => "purple",
      "광주" => "yellow"
    },
    default_color: "gray"   # 매핑에 없는 값의 기본 색상 (선택, 기본값: "gray")
  )}
```

**옵션:**

| 옵션 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `colors` | `%{String => String}` | `%{}` | 값 → 색상 매핑 |
| `default_color` | `String` | `"gray"` | 매핑에 없을 때 기본 색상 |

**사용 가능한 색상:** `blue`, `green`, `red`, `yellow`, `gray`, `purple`

---

### 3.2 Link (링크)

값을 **클릭 가능한 링크**로 표시합니다. 이메일, 전화번호, URL 등에 적합합니다.

```elixir
# 이메일 링크
%{field: :email, label: "이메일",
  renderer: LiveViewGrid.Renderers.link(prefix: "mailto:")}

# 전화번호 링크
%{field: :phone, label: "전화번호",
  renderer: LiveViewGrid.Renderers.link(prefix: "tel:")}

# 새 탭에서 열기
%{field: :website, label: "웹사이트",
  renderer: LiveViewGrid.Renderers.link(target: "_blank")}

# 커스텀 URL 생성
%{field: :name, label: "이름",
  renderer: LiveViewGrid.Renderers.link(
    href: fn row, _col -> "/users/#{row.id}" end
  )}
```

**옵션:**

| 옵션 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `prefix` | `String` | `""` | URL 접두사 (`"mailto:"`, `"tel:"` 등) |
| `target` | `String \| nil` | `nil` | 링크 target (`"_blank"` 등) |
| `href` | `fn(row, column) -> url` | `nil` | 커스텀 URL 생성 함수 |

> `href` 함수를 지정하면 `prefix`는 무시됩니다.

---

### 3.3 Progress (프로그레스바)

숫자 값을 **프로그레스바**로 표시합니다. 점수, 완료율, 나이 등에 적합합니다.

```elixir
# 나이 (최대 60세 기준, 초록색)
%{field: :age, label: "나이",
  renderer: LiveViewGrid.Renderers.progress(max: 60, color: "green")}

# 완료율 (기본 최대 100)
%{field: :progress, label: "진행률",
  renderer: LiveViewGrid.Renderers.progress(color: "blue")}

# 숫자 텍스트 숨기기
%{field: :score, label: "점수",
  renderer: LiveViewGrid.Renderers.progress(
    max: 100, color: "yellow", show_value: false
  )}
```

**옵션:**

| 옵션 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `max` | `number` | `100` | 최대값 (100% 기준) |
| `color` | `String` | `"blue"` | 바 색상 |
| `show_value` | `boolean` | `true` | 숫자 텍스트 표시 여부 |

**사용 가능한 색상:** `blue`, `green`, `red`, `yellow`

---

## 4. 커스텀 렌더러 직접 만들기

내장 프리셋 외에 자신만의 렌더러를 직접 만들 수 있습니다.

### 4.1 렌더러 함수 시그니처

```elixir
fn(row :: map(), column :: map(), assigns :: map()) -> Phoenix.LiveView.Rendered.t()
```

- `row` - 현재 행 데이터 (예: `%{id: 1, name: "Alice", city: "서울"}`)
- `column` - 컬럼 정의 (예: `%{field: :city, label: "도시", ...}`)
- `assigns` - LiveComponent의 전체 assigns

### 4.2 인라인 렌더러 예제

```elixir
# 컬럼 정의에서 직접 함수 작성
%{field: :status, label: "상태",
  renderer: fn row, column, _assigns ->
    value = Map.get(row, column.field)
    color = if value == "active", do: "green", else: "red"

    Phoenix.HTML.raw("""
    <span style="color: #{color}; font-weight: bold;">
      #{Phoenix.HTML.html_escape(value)}
    </span>
    """)
  end}
```

### 4.3 모듈 렌더러 예제

재사용 가능한 렌더러는 별도 모듈로 만들 수 있습니다.

```elixir
defmodule MyApp.GridRenderers do
  use Phoenix.Component

  @doc "숫자를 통화 형식으로 표시"
  def currency(opts \\ []) do
    unit = Keyword.get(opts, :unit, "원")

    fn row, column, _assigns ->
      value = Map.get(row, column.field) || 0
      formatted = Number.Delimit.number_to_delimited(value, precision: 0)
      assigns = %{formatted: formatted, unit: unit}

      ~H"""
      <span style="font-weight: 600;"><%= @formatted %><%= @unit %></span>
      """
    end
  end

  @doc "불리언 값을 아이콘으로 표시"
  def boolean_icon(opts \\ []) do
    true_text = Keyword.get(opts, :true_text, "O")
    false_text = Keyword.get(opts, :false_text, "X")

    fn row, column, _assigns ->
      value = Map.get(row, column.field)
      {text, color} = if value, do: {true_text, "#4caf50"}, else: {false_text, "#f44336"}
      assigns = %{text: text, color: color}

      ~H"""
      <span style={"color: #{@color}; font-weight: bold;"}><%= @text %></span>
      """
    end
  end
end
```

사용:
```elixir
%{field: :price, label: "가격",
  renderer: MyApp.GridRenderers.currency(unit: "원")}

%{field: :is_active, label: "활성",
  renderer: MyApp.GridRenderers.boolean_icon()}
```

---

## 5. 다른 기능과의 호환성

### 5.1 편집 모드와 함께 사용

렌더러는 **보기 모드**에서만 적용됩니다. 셀을 클릭하여 편집 모드에 진입하면
기존 에디터(input/select)가 표시됩니다.

```elixir
# 보기: 뱃지 표시, 편집: 드롭다운 선택
%{field: :city, label: "도시",
  editable: true,
  editor_type: :select,
  editor_options: [{"서울", "서울"}, {"부산", "부산"}],
  renderer: LiveViewGrid.Renderers.badge(
    colors: %{"서울" => "blue", "부산" => "green"}
  )}
```

### 5.2 검증(Validation)과 함께 사용

렌더러와 검증을 동시에 사용할 수 있습니다.
검증 에러가 있으면 렌더러 출력 옆에 에러 아이콘(!)과 메시지가 표시됩니다.

```elixir
%{field: :age, label: "나이",
  editable: true, editor_type: :number,
  validators: [{:min, 1, "1 이상"}, {:max, 150, "150 이하"}],
  renderer: LiveViewGrid.Renderers.progress(max: 60, color: "green")}
```

### 5.3 정렬/필터와 함께 사용

렌더러는 표시 방식만 변경하므로 정렬, 필터링은 원본 데이터 값으로 동작합니다.

```elixir
%{field: :email, label: "이메일",
  sortable: true,
  filterable: true,
  filter_type: :text,
  renderer: LiveViewGrid.Renderers.link(prefix: "mailto:")}
```

---

## 6. 에러 처리

렌더러 함수에서 에러가 발생하면 자동으로 **plain text로 fallback** 됩니다.
그리드가 멈추거나 깨지지 않습니다.

```elixir
# 이 렌더러가 에러를 발생시키면...
%{field: :data, label: "데이터",
  renderer: fn _row, _column, _assigns ->
    raise "something went wrong"
  end}
# → 셀 값이 일반 텍스트로 표시됨 (fallback)
```

---

## 7. 전체 적용 예시 (demo_live.ex)

```elixir
<.live_component
  module={LiveviewGridWeb.GridComponent}
  id="users-grid"
  data={@users}
  columns={[
    %{field: :id, label: "ID", width: 80, sortable: true},

    %{field: :name, label: "이름", width: 150, sortable: true,
      editable: true,
      validators: [{:required, "이름은 필수입니다"}]},

    %{field: :email, label: "이메일", width: 250, sortable: true,
      editable: true,
      validators: [{:required, "이메일은 필수입니다"},
                   {:pattern, ~r/@/, "이메일 형식이 올바르지 않습니다"}],
      renderer: LiveViewGrid.Renderers.link(prefix: "mailto:")},

    %{field: :age, label: "나이", width: 100, sortable: true,
      editable: true, editor_type: :number,
      validators: [{:required, "나이는 필수입니다"},
                   {:min, 1, "1 이상"}, {:max, 150, "150 이하"}],
      renderer: LiveViewGrid.Renderers.progress(max: 60, color: "green")},

    %{field: :city, label: "도시", width: 120, sortable: true,
      editable: true, editor_type: :select,
      editor_options: [{"서울", "서울"}, {"부산", "부산"}, {"대구", "대구"}],
      renderer: LiveViewGrid.Renderers.badge(
        colors: %{"서울" => "blue", "부산" => "green", "대구" => "red",
                  "인천" => "purple", "광주" => "yellow"})}
  ]}
  options={%{page_size: 20}}
/>
```

---

## 8. CSS 커스터마이징

렌더러의 스타일을 변경하려면 `liveview_grid.css`의 해당 클래스를 오버라이드합니다.

### 뱃지 클래스

```css
.lv-grid__badge              /* 뱃지 공통 스타일 */
.lv-grid__badge--blue        /* 파란색 */
.lv-grid__badge--green       /* 초록색 */
.lv-grid__badge--red         /* 빨간색 */
.lv-grid__badge--yellow      /* 노란색 */
.lv-grid__badge--gray        /* 회색 */
.lv-grid__badge--purple      /* 보라색 */
```

### 링크 클래스

```css
.lv-grid__link               /* 링크 스타일 */
.lv-grid__link:hover         /* 호버 시 밑줄 */
```

### 프로그레스바 클래스

```css
.lv-grid__progress           /* 전체 컨테이너 (flex) */
.lv-grid__progress-track     /* 배경 트랙 */
.lv-grid__progress-fill      /* 채워지는 바 */
.lv-grid__progress-fill--blue
.lv-grid__progress-fill--green
.lv-grid__progress-fill--red
.lv-grid__progress-fill--yellow
.lv-grid__progress-text      /* 숫자 텍스트 */
```

### 새 색상 추가 예시

```css
/* 커스텀 뱃지 색상 */
.lv-grid__badge--orange { background: #fff3e0; color: #e65100; }
.lv-grid__badge--teal   { background: #e0f2f1; color: #00695c; }

/* 커스텀 프로그레스바 색상 */
.lv-grid__progress-fill--orange { background: #e65100; }
```

---

## 요약

| 항목 | 내용 |
|------|------|
| 사용 방법 | 컬럼 정의에 `renderer: 함수` 추가 |
| 내장 프리셋 | `badge`, `link`, `progress` |
| 커스텀 | `fn(row, column, assigns) -> HEEx` 함수 직접 작성 |
| 편집 모드 | 렌더러 무시, 기존 에디터 표시 |
| 에러 처리 | 자동 fallback (plain text) |
| 호환성 | 정렬, 필터, 검증 모두 정상 동작 |
